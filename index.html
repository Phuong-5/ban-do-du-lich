<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì Ph∆∞·ªùng 5</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* üîπ Layout chu·∫©n */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: row;
        }
        #sidebar {
            width: 250px;
            background: #fff;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            display: none;
            flex-direction: column;
            align-items: center; /* Ch·ªânh t·ª´ left -> flex-start */
            position: absolute;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
        }

        #sidebar-name {
            margin-bottom: 15px; /* Gi·∫£m kho·∫£ng c√°ch d∆∞·ªõi */
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.2; /* ƒêi·ªÅu ch·ªânh kho·∫£ng c√°ch d√≤ng */
        }

        #sidebar-address {
            margin-top: 0px; /* Gi·∫£m kho·∫£ng c√°ch tr√™n */
            font-size: 16px;
            color: #555;
            line-height: 1.2;
            margin-bottom: 0px;
        }
        .sidebar-note {
            margin-top: 0px; /* Gi·∫£m kho·∫£ng c√°ch v·ªõi ƒë·ªãa ch·ªâ */
            font-style: italic; /* (Tu·ª≥ ch·ªçn) L√†m ghi ch√∫ nghi√™ng ƒë·ªÉ n·ªïi b·∫≠t */
            color: gray; /* (Tu·ª≥ ch·ªçn) ƒê·ªïi m√†u ghi ch√∫ */
        }
        #map {
            flex: 1;
            height: 100vh;
            min-width: 0;
            display: block;
        }
        .locate-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 18px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .close-btn {
            background: red;
            color: white;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 50px;
            position: absolute;
            top: 6px;
            right: 8px;
        }
        .images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: left;
        }
        .sidebar-image {
            width: 95%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .marker-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50% !important;
            aspect-ratio: 1 / 1;  /* ƒê·∫£m b·∫£o lu√¥n l√† h√¨nh vu√¥ng */
            object-fit: cover;
        }
        .marker-image {
            width: 100px;
            height: auto;
            border-radius: 10px;
            margin-top: 5px;
        }
        .marker-extra-images {
            display: flex;
            gap: 3px;
            justify-content: left;
            margin-top: 5px;
        }
        /* üÜï Modal hi·ªÉn th·ªã ·∫£nh khi click */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }

    </style>
</head>
<body>
    <div id="sidebar">
        <button class="close-btn" onclick="hideSidebar()">‚úñ</button>
        <h2>Th√¥ng tin ƒëi·ªÉm ƒë·∫øn</h2>
        <img id="sidebar-avatar" class="sidebar-image" style="width: 90%; max-height: 150px; object-fit: cover; border-radius: 10px;">
        <h3 id="sidebar-name"></h3> <!-- T√™n ƒë·ªãa ƒëi·ªÉm-->
        <p id="sidebar-address"></p> <!-- ƒê·ªãa ch·ªâ-->
        <p id="sidebar-note"></p> <!-- Ghi ch√∫ -->
        <div class="images-container" id="sidebar-images"></div>
    </div>
    <div id="map"></div>
    <button class="locate-btn" onclick="locateUser()">üìç</button>

    <!-- üÜï Modal ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh -->
    <div id="imageModal" class="modal">
        <!-- D·∫•u "X" ƒë·ªÉ ƒë√≥ng modal -->
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let sidebar = document.getElementById("sidebar");
            let sidebarImages = document.getElementById("sidebar-images");

            const map = L.map('map', {
                zoomControl: false,
                minZoom: 17,
                maxZoom: 18
            }).setView([10.760000, 106.660000], 16)
              .setMaxBounds([[10.754345, 106.664810], [10.748590, 106.679998]])
              .fitBounds([[10.754345, 106.664810], [10.748590, 106.679998]]);

            L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap France'
            }).addTo(map);

            var sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZpvmiU7kOaeFAG9sevuBQSK09TtzCgtup51T-XHg5ernaqxd-j9_RCsKcCrrDL_e8Ohjvv6EshzXg/pub?gid=0&single=true&output=csv";

            fetch(sheetURL)
                .then(response => response.text())
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            results.data.forEach(m => {
                                let lat = parseFloat(m.Latitude?.trim()?.replace(',', '.'));
                                let lng = parseFloat(m.Longitude?.trim()?.replace(',', '.'));

                                if (isNaN(lat) || isNaN(lng)) return;

                                let images = m.Image ? m.Image.split(",").map(img => img.trim()) : [];
                                let avatar = images.length > 0 ? images[0] : "https://placehold.co/100"; // ·∫¢nh m·∫∑c ƒë·ªãnh n·∫øu thi·∫øu

                                let icon = L.divIcon({
                                    className: '',
                                    html: `<div style="text-align:center;">
                                            <img src="${avatar}" class="marker-avatar">
                                            <div><b>${m.Name}</b></div>
                                        </div>`,
                                    iconSize: [100, 80]
                                });

                                let marker = L.marker([lat, lng], { icon }).addTo(map);
                                
                                marker.on("click", () => {
                                    showSidebar(m);
                                });
                            });
                        }
                    });
                });

                function showSidebar(data) {
                document.getElementById("sidebar-name").innerText = data.Name || "Kh√¥ng c√≥ t√™n";
                document.getElementById("sidebar-address").innerText = data.Address || "Kh√¥ng c√≥ ƒë·ªãa ch·ªâ";
                document.getElementById("sidebar-note").innerText = data.Note || "Kh√¥ng c√≥ ghi ch√∫"; // Th√™m ghi ch√∫

                let sidebarImages = document.getElementById("sidebar-images");
                sidebarImages.innerHTML = ""; // X√≥a ·∫£nh c≈©

                let images = data.Image ? data.Image.split(",").map(img => img.trim()) : [];

                // N·∫øu c√≥ ·∫£nh, hi·ªÉn th·ªã ·∫£nh ƒë·∫ßu ti√™n nh∆∞ avatar tr√™n c√πng
                let avatar = images.length > 0 ? images[0] : "https://placehold.co/100";
                let sidebarAvatar = document.getElementById("sidebar-avatar");
                sidebarAvatar.src = avatar;
                sidebarAvatar.onclick = function() { openModal(avatar); }; // üÜï Th√™m s·ª± ki·ªán m·ªü modal

                // Hi·ªÉn th·ªã c√°c ·∫£nh c√≤n l·∫°i xu·ªëng d∆∞·ªõi ƒë·ªãa ch·ªâ
                let otherImages = images.slice(1);
                if (otherImages.length === 0) {
                    sidebarImages.innerHTML = "<p>Kh√¥ng c√≥ h√¨nh ·∫£nh</p>";
                } else {
                    otherImages.forEach(imgSrc => {
                        let img = document.createElement("img");
                        img.src = imgSrc;
                        img.className = "sidebar-image clickable-image";
                        img.onclick = function() { openModal(imgSrc); }; // üÜï Th√™m s·ª± ki·ªán m·ªü modal
                        sidebarImages.appendChild(img);
                    });
                }

                document.getElementById("sidebar").style.display = "flex";
            }


            function openModal(imageSrc) {
                let modal = document.getElementById("imageModal");
                let modalImg = document.getElementById("modalImage");
                modal.style.display = "flex";
                modalImg.src = imageSrc;
            }

            // üÜï H√†m ƒë√≥ng modal khi nh·∫•n v√†o v√πng ngo√†i ·∫£nh
            function closeModal() {
                let modal = document.getElementById("imageModal");
                modal.style.display = "none";
            }

            // üÜï ƒê√≥ng modal n·∫øu nh·∫•n ra ngo√†i ·∫£nh
            document.getElementById("imageModal").addEventListener("click", function(event) {
                if (event.target === this) {
                    closeModal();
                }
            });
            // üÜï G√°n h√†m v√†o window ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ th·ªÉ g·ªçi t·ª´ HTML
            window.closeModal = closeModal;

            function hideSidebar() {
                sidebar.style.display = "none";
            }

            function locateUser() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLocation = [position.coords.latitude, position.coords.longitude];
                            L.marker(userLocation, { title: "V·ªã tr√≠ c·ªßa b·∫°n" })
                                .addTo(map)
                                .bindPopup("B·∫°n ƒëang ·ªü ƒë√¢y!")
                                .openPopup();
                            map.setView(userLocation, 18);
                        },
                        () => {
                            alert("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ c·ªßa b·∫°n!");
                        }
                    );
                } else {
                    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!");
                }
            }

            window.locateUser = locateUser;
            window.hideSidebar = hideSidebar;
        });
    </script>
</body>
</html>
